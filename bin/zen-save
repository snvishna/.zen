#!/bin/bash
# ï£¿ Zen Save v3.9
# Granular System Snapshotting & Cloud Sync.
# Features: Smart App Filtering (Aggressive Matching), macOS Defaults, Raycast Config, Full Logging.

set -e

# --- Configuration ---
ZEN_HOME="${HOME}/.zen"
MANIFESTS="${ZEN_HOME}/manifests"
LOG_FILE="${MANIFESTS}/last_backup.log"
BIN_SYNC="${ZEN_HOME}/bin/dfsync"

# --- Colors ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Ensure manifests directory exists
mkdir -p "$MANIFESTS"

# --- Help Menu ---
show_help() {
    echo -e "${BLUE}Zen Save - System Snapshotter${NC}"
    echo -e "Usage: zen-save [OPTIONS]"
    echo -e "\n${YELLOW}Snapshot Options:${NC}"
    echo -e "  (no args)   Snapshots EVERYTHING and Syncs to Cloud."
    echo -e "  --all       Force snapshot of all categories."
    echo -e "  --brew      Dump Brewfile (Formulae, Casks, Taps)."
    echo -e "  --npm       Dump global Node.js packages."
    echo -e "  --vscode    Dump VS Code extensions list."
    echo -e '  --apps      Dump /Applications (Excludes Brew/MAS apps!).'
    echo -e "  --defaults  Snapshot raw 'defaults read' output."
    echo -e "  --raycast   Standardize Raycast exports & backup plist."
    echo -e "\n${YELLOW}Sync Options:${NC}"
    echo -e "  (default)   Automatically runs dfsync (Push to Cloud)."
    echo -e "  --sync      Explicitly run dfsync."
    echo -e "  --local     Snapshot ONLY. Do not push to cloud."
    echo -e "  --no-sync   Alias for --local."
    echo -e "\n${YELLOW}Other:${NC}"
    echo -e "  --help      Show this help message."
    exit 0
}

# --- Snapshot Functions ---

dump_brew() {
    if command -v brew &> /dev/null; then
        echo -e "ðŸ“¦ Dumping Homebrew..."
        local brewfile="${MANIFESTS}/Brewfile"

        # brew bundle dump --describe --file="${MANIFESTS}/Brewfile" --force
        brew info --json=v2 --installed | jq -r --arg leaves "$(brew leaves; brew list --cask)" '
            ($leaves | split("\n") | map(select(length > 0))) as $whitelist |
            
            (
                # Process Formulae
                [.formulae[] | select(.full_name as $n | $whitelist | index($n)) | 
                {name: .full_name, time: .installed[0].time, type: "brew", desc: .desc}] 
                +
                # Process Casks
                [.casks[] | select(.token as $t | $whitelist | index($t)) | 
                {name: .token, time: .time, type: "cask", desc: .desc}]
            ) 
            | sort_by(.time)[] 
            | "# \(.desc // "No description")\n\(.type) \"\(.name)\""
            ' > "$brewfile"

        # 2. Append VS Code extensions (Homebrew manages them via the vscode prefix)
        # We grab these from the existing bundle dump logic because 'brew info' doesn't list them
        brew bundle dump --file=/dev/stdout | grep "^vscode" >> "$brewfile"

        echo -e "${GREEN}âœ”ï¸Ž Brewfile updated.${NC}"
    else
        echo -e "${RED}[SKIP]${NC} Homebrew not found."
    fi
}

dump_npm() {
    if command -v npm &> /dev/null; then
        echo -e "ðŸŸ¢ Dumping NPM Globals..."
        if command -v jq &> /dev/null; then
            npm list -g --depth=0 --json | jq -r '.dependencies | keys[]' > "${MANIFESTS}/npm_globals.txt"
        else
            npm list -g --depth=0 | grep -v 'â”œâ”€â”€' | grep -v 'â””â”€â”€' | awk '{print $2}' | cut -d@ -f1 > "${MANIFESTS}/npm_globals.txt"
        fi
        echo -e "${GREEN}âœ”ï¸Ž NPM list updated.${NC}"
    else
        echo -e "${RED}[SKIP]${NC} NPM not found."
    fi
}

dump_vscode() {
    if command -v code &> /dev/null; then
        echo -e "ðŸŸ£ Dumping VS Code Extensions..."
        code --list-extensions > "${ZEN_HOME}/config/vscode/extensions.txt"
        echo -e "${GREEN}âœ”ï¸Ž Extensions list updated.${NC}"
    else
        echo -e "${RED}[SKIP]${NC} VS Code ('code') not found."
    fi
}

dump_apps() {
    echo -e "ðŸŽ Dumping Application List (Manual Installs Only)..."
    local output_file="${MANIFESTS}/installed_apps.txt"
    local ignore_list=$(mktemp)

    # 1. Build Ignore List (SQUASHED MATCHING)
    # We strip ' -@' characters to ensure "AltTab" matches "alt-tab" and "firefox@developer" matches "firefoxdeveloper"
    if command -v brew &> /dev/null; then
        brew list --cask -1 | tr -d ' -@' | tr '[:upper:]' '[:lower:]' >> "$ignore_list"
    fi

    if command -v mas &> /dev/null; then
        mas list | sed -E 's/^[0-9]+ (.+) \(.*\)$/\1/' | tr -d ' -@' | tr '[:upper:]' '[:lower:]' >> "$ignore_list"
    else
        # Manual Apple defaults (Squashed names)
        echo "garageband" >> "$ignore_list"
        echo "imovie" >> "$ignore_list"
        echo "keynote" >> "$ignore_list"
        echo "numbers" >> "$ignore_list"
        echo "pages" >> "$ignore_list"
        echo "xcode" >> "$ignore_list"
    fi

    > "$output_file"

    shopt -s nullglob
    for app_path in /Applications/*.app; do
        local full_name=$(basename "$app_path")
        local app_name="${full_name%.*}"

        # Generate Squashed Token for the App on Disk
        # "Firefox Developer Edition" -> "firefoxdeveloperedition"
        # "AltTab" -> "alttab"
        local token=$(echo "$app_name" | tr -d ' -@' | tr '[:upper:]' '[:lower:]')

        # Hardcoded System Skips
        [[ "$app_name" == "Safari" ]] && continue
        [[ "$app_name" == "Utilities" ]] && continue

        # Compare against the Squashed Ignore List
        if grep -Fxq "$token" "$ignore_list"; then
            continue
        fi
        
        echo "$full_name" >> "$output_file"
    done
    shopt -u nullglob

    rm "$ignore_list"
    echo -e "${GREEN}âœ”ï¸Ž App list updated.${NC}"
}

# --- NEW FUNCTION: Defaults Snapshot ---
dump_defaults() {
    echo -e "âš™ï¸  Snapshotting macOS Defaults..."
    local defaults_dir="${MANIFESTS}/macos"
    mkdir -p "$defaults_dir"
    
    # Save the full output to a text file for future reference/diffing
    defaults read > "${defaults_dir}/all_settings_bak.txt"
    
    echo -e "${GREEN}âœ”ï¸Ž Defaults exported to manifests/macos/all_settings_bak.txt${NC}"
}

# --- NEW FUNCTION: Raycast Processing ---
dump_raycast() {
    echo -e "ðŸ”® Processing Raycast Backups..."
    local raycast_dir="${ZEN_HOME}/config/raycast"
    local standard_config="${raycast_dir}/Raycast.rayconfig"
    
    # 1. Handle Manual Exports (.rayconfig)
    # Find the newest file matching the pattern "Raycast 20*.rayconfig"
    local newest_export=$(ls -t "${raycast_dir}"/Raycast\ 20*.rayconfig 2>/dev/null | head -n 1)

    if [[ -n "$newest_export" ]]; then
        # Rename the timestamped file to a standard name for Git tracking
        mv "$newest_export" "$standard_config"
        echo -e "${GREEN}âœ”ï¸Ž Standardized newest export to Raycast.rayconfig${NC}"
    elif [[ -f "$standard_config" ]]; then
        echo -e "${YELLOW}[INFO]${NC} No new manual export found. Using existing config."
    else
        echo -e "${RED}[MISSING]${NC} Please export settings manually: Raycast Settings > Advanced > Export"
    fi

    # 2. Backup Plist (Preferences)
    # This captures simple settings like hotkeys
    cp "${HOME}/Library/Preferences/com.raycast.macos.plist" "${raycast_dir}/com.raycast.macos.plist" 2>/dev/null
    echo -e "${GREEN}âœ”ï¸Ž Raycast preferences plist backed up.${NC}"
}

run_sync() {
    echo -e "\n${BLUE}--- â˜ï¸  Syncing to Cloud ---${NC}"
    if [[ -x "$BIN_SYNC" ]]; then
        "$BIN_SYNC" push -y
    elif command -v dfsync &> /dev/null; then
        dfsync push -y -v
    else
        echo -e "${RED}[ERROR]${NC} dfsync not found. Cannot push."
        exit 1
    fi
    echo -e "${GREEN}âœ”ï¸Ž Cloud Sync Complete.${NC}"
}

# --- Core Execution Wrapper ---
# This function runs the logic so we can pipe it all to the log file later
perform_snapshot() {
    local do_brew="$1"
    local do_npm="$2"
    local do_vscode="$3"
    local do_apps="$4"
    local do_defaults="$5"
    local do_raycast="$6"
    local do_sync="$7"

    echo "========================================"
    echo "Zen Snapshot Started: $(date)"
    echo "========================================"

    [[ "$do_brew" == "true" ]]     && dump_brew
    [[ "$do_npm" == "true" ]]      && dump_npm
    [[ "$do_vscode" == "true" ]]   && dump_vscode
    [[ "$do_apps" == "true" ]]     && dump_apps
    [[ "$do_defaults" == "true" ]] && dump_defaults
    [[ "$do_raycast" == "true" ]]  && dump_raycast

    if [[ "$do_sync" == "true" ]]; then
        run_sync
    else
        echo -e "\n${YELLOW}â„¹ï¸  Skipping Cloud Sync (--local used).${NC}"
        echo -e "${GREEN}âœ”ï¸Ž Local Snapshots Saved.${NC}"
    fi
}

# --- Main Logic ---
main() {
    local do_brew=false; local do_npm=false; local do_vscode=false
    local do_apps=false; local do_defaults=false; local do_raycast=false; local do_sync=true 

    # Parse Arguments
    if [[ $# -eq 0 ]]; then
        # Default: Do Everything
        do_brew=true; do_npm=true; do_vscode=true; do_apps=true; do_defaults=true; do_raycast=true; do_sync=true
    else
        local specific_snapshot=false
        for arg in "$@"; do
            case $arg in
                --help|-h)    show_help ;;
                --brew)       do_brew=true; specific_snapshot=true ;;
                --npm)        do_npm=true; specific_snapshot=true ;;
                --vscode)     do_vscode=true; specific_snapshot=true ;;
                --apps)       do_apps=true; specific_snapshot=true ;;
                --defaults)   do_defaults=true; specific_snapshot=true ;;
                --raycast)    do_raycast=true; specific_snapshot=true ;;
                --all)        do_brew=true; do_npm=true; do_vscode=true; do_apps=true; do_defaults=true; do_raycast=true ;;
                --sync)       do_sync=true ;;
                --local)      do_sync=false ;;
                --no-sync)    do_sync=false ;;
                *)            echo -e "${RED}Unknown option: $arg${NC}"; show_help ;;
            esac
        done
        
        if [[ "$specific_snapshot" == "false" ]]; then
            do_brew=true; do_npm=true; do_vscode=true; do_apps=true; do_defaults=true; do_raycast=true
        fi
    fi

    # Execute and Pipe Output to Screen AND File
    # 2>&1 ensures errors are logged too
    perform_snapshot "$do_brew" "$do_npm" "$do_vscode" "$do_apps" "$do_defaults" "$do_raycast" "$do_sync" | tee "$LOG_FILE"
}

main "$@"
