#!/bin/bash
# ï£¿ Zen Load v4.7
# Granular System Restoration: Symlinks, Brew, NPM, VS Code, macOS Defaults, dfsync.
# FEATURES: Dynamic App De-quarantine, Sudo Keep-alive, Standalone dfsync Integration.

set -e

# --- Configuration ---
ZEN_HOME="${HOME}/.zen"
CONFIG_DEST="${HOME}/.config"
BIN_DEST="${HOME}/.local/bin"
LAUNCH_DEST="${HOME}/Library/LaunchAgents"

# Manifests
BREWFILE="${ZEN_HOME}/manifests/Brewfile"
NPM_LIST="${ZEN_HOME}/manifests/npm_globals.txt"
VSCODE_LIST="${ZEN_HOME}/config/vscode/extensions.txt"
MACOS_SCRIPT="${ZEN_HOME}/config/macos/defaults.sh"
LAUNCH_PLIST="${ZEN_HOME}/launchd/com.shankar.configbackup.plist"

# Upstream Source
DFSYNC_URL="https://raw.githubusercontent.com/snvishna/dotfilesync/master/src/dfsync.sh"

# --- SYMLINK CONFIGURATION ---
SYMLINKS=(
    "config/zsh/.zshrc|${HOME}/.zshrc"
    "config/zsh/.zprofile|${HOME}/.zprofile"
    "config/wezterm|${CONFIG_DEST}/wezterm"
    "config/starship.toml|${CONFIG_DEST}/starship.toml"
    "config/zim|${CONFIG_DEST}/zim"
    "config/vscode|${CONFIG_DEST}/vscode"
    "config/rectangle|${CONFIG_DEST}/rectangle"
    "config/finder/Recents.savedSearch|${HOME}/Library/Saved Searches/Recents.savedSearch"
    "bin/zen-save|${BIN_DEST}/zen-save"
    "bin/zen-load|${BIN_DEST}/zen-load"
    "config/git/gitconfig|${HOME}/.gitconfig"
)

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
GRAY='\033[0;90m'
NC='\033[0m'

# --- Helper: Shorten Paths ---
shorten_path() { echo "${1//$HOME/~}"; }

# --- Help Menu ---
show_help() {
    echo -e "${BLUE}Zen Load - Environment Restorer${NC}"
    echo -e "Usage: zen-load [OPTIONS]"
    echo -e "\n${YELLOW}Core:${NC}"
    echo -e "  (no args)   Restores symlinks for config files only (Fast)."
    echo -e "  --check     Dry-run to detect conflicts without making changes."
    echo -e "\n${YELLOW}Installers:${NC}"
    echo -e "  --all       God Mode. Installs EVERYTHING (Brew, dfsync, NPM, VSCode, macOS)."
    echo -e "  --force     Overwrite existing dfsync binary with latest version."
    echo -e "  --brew      Install Homebrew and packages from Brewfile."
    echo -e "  --dfsync    Install dfsync (if missing), Setup, and Pull from Gist."
    echo -e "  --npm       Install Node.js global packages."
    echo -e "  --vscode    Install VS Code extensions (Parallelized)."
    echo -e "  --macos     Apply macOS system defaults (Dock, Finder, etc)."
    echo -e "  --launch    Install and load the auto-backup LaunchAgent."
    echo -e "\n${YELLOW}Flags:${NC}"
    echo -e "  -y          Auto-confirm dfsync prompts (Batch Mode)."
    echo -e "  -v          Verbose logging for dfsync."
    echo -e "  --help      Show this help message."
    exit 0
}

# --- 1. Smart Linker ---
process_link() {
    local rel_src="$1"
    local dest="$2"
    local mode="$3"
    
    local src="${ZEN_HOME}/${rel_src}"
    local short_dest=$(shorten_path "$dest")

    if [[ ! -e "$src" ]]; then
        echo -e "${RED}[MISSING]${NC}  Source file not found: $rel_src"
        return
    fi

    if [[ "$mode" == "check" ]]; then
        if [[ -L "$dest" && "$(readlink "$dest")" == "$src" ]]; then
            echo -e "${GREEN}[OK]       $short_dest${NC}"
        elif [[ -e "$dest" || -L "$dest" ]]; then
            echo -e "${YELLOW}[CONFLICT] $short_dest needs update.${NC}"
        else
            echo -e "${GREEN}[NEW]      $short_dest will be created.${NC}"
        fi
        return
    fi

    mkdir -p "$(dirname "$dest")"
    if [[ -e "$dest" && ! -L "$dest" ]]; then
        mv "$dest" "${dest}.bak"
        echo -e "${YELLOW}[BACKUP]   Moved existing file to ${short_dest}.bak${NC}"
    fi

    ln -sfn "$src" "$dest"
    echo -e "${GREEN}[LINKED]   $short_dest -> $rel_src${NC}"
}

# --- 2. Installers ---
install_homebrew() {
    echo -e "\n--- ðŸº Installing Homebrew Packages ---"
    if ! command -v brew &> /dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || /usr/local/bin/brew shellenv)"
    fi
    if [[ -f "$BREWFILE" ]]; then
        brew bundle install --file="$BREWFILE"
        echo -e "${GREEN}âœ”ï¸Ž Brew bundle complete.${NC}"
        
        # --- FIX: Refresh Font Cache (Fixes WezTerm Spacing) ---
        echo "Refreshing font cache..."
        atsutil server -shutdown 2>/dev/null || true
        atsutil server -ping 2>/dev/null || true
    else
        echo -e "${YELLOW}[SKIP]${NC} No Brewfile found."
    fi
}

# --- FIX: Scalable App De-quarantine ---
fix_quarantine() {
    echo -e "\n--- ðŸ”“ Unlocking Applications (Scalable Search) ---"
    # Target all .app bundles in /Applications
    local apps_to_fix
    apps_to_fix=$(find /Applications -maxdepth 1 -name "*.app" -type d 2>/dev/null)
    
    if [[ -n "$apps_to_fix" ]]; then
        echo "$apps_to_fix" | while read -r app; do
            # Only run xattr if the attribute actually exists to save time/sudo hits
            if xattr "$app" 2>/dev/null | grep -q "com.apple.quarantine"; then
                sudo xattr -rd com.apple.quarantine "$app" 2>/dev/null || true
                echo -e "  - Unlocked $(basename "$app")"
            fi
        done
    fi
}

install_dfsync() {
    local force_update="$1"
    local dfsync_args="$2"
    echo -e "\n--- â˜ï¸  Installing/Configuring dfsync ---"
    local bin_path="${BIN_DEST}/dfsync"
    local installed=false

    # 1. Install/Update Binary (Clean download, no .sh extension)
    if [[ ! -x "$bin_path" || "$force_update" == "true" ]]; then
        echo -e "Downloading latest dfsync from GitHub..."
        if curl -fsSL "$DFSYNC_URL" -o "$bin_path"; then
            chmod +x "$bin_path"
            
            # Validation (Check for Shebang)
            if head -n 1 "$bin_path" | grep -q "#!"; then
                echo -e "${GREEN}âœ”ï¸Ž dfsync binary installed and validated.${NC}"
                installed=true
            else
                echo -e "${RED}[ERROR]${NC} Downloaded file is invalid (No shebang found)."
                rm "$bin_path"
                return
            fi
        else
            echo -e "${RED}[ERROR]${NC} Failed to download dfsync."
            return
        fi
    else
        echo -e "${YELLOW}[SKIP]${NC} dfsync already installed."
        installed=true
    fi

    # 2. Standalone Setup & Restoration
    if [[ "$installed" == "true" ]]; then
        echo -e "Running dfsync setup..."
        "$bin_path" setup $dfsync_args

        echo -e "Running dfsync pull..."
        "$bin_path" pull $dfsync_args
    fi
}

install_npm_globals() {
    echo -e "\n--- ðŸŸ¢ Installing NPM Globals ---"
    if command -v npm &> /dev/null && [[ -f "$NPM_LIST" ]]; then
        grep -vE '^\s*#|^\s*$' "$NPM_LIST" | while read -r pkg; do
            npm list -g "$pkg" &> /dev/null || (echo "Installing $pkg..." && npm install -g "$pkg")
        done
        echo -e "${GREEN}âœ”ï¸Ž NPM globals verified.${NC}"
    else
        echo -e "${GRAY}(Skipping NPM: Node not found)${NC}"
    fi
}

install_vscode_extensions() {
    echo -e "\n--- ðŸŸ£ Installing VS Code Extensions ---"
    if command -v code &> /dev/null && [[ -f "$VSCODE_LIST" ]]; then
        grep -vE '^\s*#|^\s*$' "$VSCODE_LIST" | \
        xargs -L 1 -P 4 code --install-extension --force > /dev/null 2>&1
        echo -e "${GREEN}âœ”ï¸Ž VS Code extensions installed.${NC}"
    fi
}

install_macos_defaults() {
    echo -e "\n--- ðŸŽ Applying macOS Defaults ---"
    if [[ -x "$MACOS_SCRIPT" ]]; then
        "$MACOS_SCRIPT"
        echo -e "${GREEN}âœ”ï¸Ž System defaults applied.${NC}"
    fi
}

setup_launchagent() {
    echo -e "\n--- â± Setting up Auto-Backup LaunchAgent ---"
    local template="${ZEN_HOME}/launchd/com.template.configbackup.plist"
    local dest_plist="${LAUNCH_DEST}/com.shankar.configbackup.plist"
    
    if [[ -f "$template" ]]; then
        sed "s|{{HOME}}|${HOME}|g" "$template" > "$dest_plist"
        launchctl bootout gui/$(id -u) "$dest_plist" 2>/dev/null || true
        launchctl bootstrap gui/$(id -u) "$dest_plist"
        echo -e "${GREEN}âœ”ï¸Ž LaunchAgent loaded.${NC}"
    fi
}

# --- Main Logic ---
main() {
    local mode="apply"
    local do_brew=false; local do_npm=false; local do_vscode=false
    local do_macos=false; local do_launch=false; local do_dfsync=false
    local force_update=false
    local dfsync_args=""

    for arg in "$@"; do
        case $arg in
            --check|-c)   mode="check" ;;
            --all)        do_brew=true; do_dfsync=true; do_npm=true; do_vscode=true; do_macos=true; do_launch=true ;;
            --brew)       do_brew=true ;;
            --dfsync)     do_dfsync=true ;;
            --npm)        do_npm=true ;;
            --vscode)     do_vscode=true ;;
            --macos)      do_macos=true ;;
            --launch)     do_launch=true ;;
            --force)      force_update=true ;;
            -y)           dfsync_args+=" -y" ;;
            -v)           dfsync_args+=" -v" ;;
            --help|-h)    show_help ;;
        esac
    done

    if [[ "$mode" == "check" ]]; then
        echo "--- ðŸ” Running Pre-Flight Conflict Check ---"
    else
        echo "--- ðŸš€ Applying Zen Configuration ---"
        # --- FIX: Sudo Keep-alive (Ask once, background refresh) ---
        echo -e "${YELLOW}ðŸ” Zen requires admin privileges. Enter password:${NC}"
        sudo -v
        while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
    fi

    mkdir -p "$CONFIG_DEST" "$BIN_DEST" "$LAUNCH_DEST"
    mkdir -p "${HOME}/.config/zsh" 2>/dev/null

    for mapping in "${SYMLINKS[@]}"; do
        process_link "${mapping%%|*}" "${mapping#*|}" "$mode"
    done

    if [[ "$mode" != "check" ]]; then
        # Order: Brew (Fonts/Apps) -> Quarantine Fix -> dfsync (Configs) -> Rest
        [[ "$do_brew" == "true" ]]   && install_homebrew && fix_quarantine
        [[ "$do_dfsync" == "true" ]] && install_dfsync "$force_update" "$dfsync_args"
        [[ "$do_npm" == "true" ]]    && install_npm_globals
        [[ "$do_vscode" == "true" ]] && install_vscode_extensions
        [[ "$do_launch" == "true" ]] && setup_launchagent
        [[ "$do_macos" == "true" ]]  && install_macos_defaults
    fi

    echo -e "\n${GREEN}âœ”ï¸Ž Zen Environment Processed.${NC}"
}

main "$@"
