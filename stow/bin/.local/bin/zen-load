#!/bin/bash
# Ô£ø Zen Load v5.0 (Stow Edition)
# Granular System Restoration: Stow, Brew, NPM, VS Code, macOS Defaults, dfsync.

set -e

# --- Configuration ---
ZEN_HOME="${HOME}/.zen"
STOW_DIR="${ZEN_HOME}/stow"
MANIFESTS="${ZEN_HOME}/manifests"
BREWFILE="${MANIFESTS}/Brewfile"
NPM_LIST="${MANIFESTS}/npm_globals.txt"
VSCODE_LIST="${STOW_DIR}/vscode/.config/vscode/extensions.txt"
MACOS_SCRIPT="${MANIFESTS}/macos/defaults.sh"

# Upstream Source
DFSYNC_URL="https://raw.githubusercontent.com/snvishna/dotfilesync/master/src/dfsync.sh"

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
GRAY='\033[0;90m'
NC='\033[0m'

# --- 0. Helpers ---
prompt_user() {
    local msg="$1"
    if [[ "$FORCE_ALL" == "true" ]]; then return 0; fi
    if [[ "$CHECK_MODE" == "true" ]]; then return 0; fi
    read -p "$msg [y/N] " -n 1 -r; echo ""
    [[ $REPLY =~ ^[Yy]$ ]]
}

dfsync_activate() {
    local pattern="$1"
    local bin="${HOME}/.local/bin/dfsync"
    local catalog="${ZEN_HOME}/dfsync.json"
    
    if [[ ! -x "$bin" ]]; then return 0; fi
    
    # 1. Initialize local config if needed
    if [[ ! -f "${HOME}/.dfsync.json" ]]; then
        # Grab Gist ID from catalog
        local gid=$(grep -E '"gist_id":' "$catalog" | cut -d'"' -f4)
        echo "{\"gist_id\": \"$gid\", \"files\": []}" > "${HOME}/.dfsync.json"
    fi
    
    # 2. Extract matching files from catalog (grep regex)
    local files=$(grep -E "$pattern" "$catalog" | sed 's/^[[:space:]]*"//;s/",\?//' | tr -d ' ')
    
    if [[ -n "$files" ]]; then
        echo "  - Registering cloud configs for pattern: '$pattern'"
        
        while IFS= read -r line; do
             if [[ -n "$line" ]]; then
                 if [[ "$CHECK_MODE" == "true" ]]; then
                     echo "    [Dry Run] Would track: $line"
                 else
                     # Track file (Adds to ~/.dfsync.json)
                     "$bin" track "$line" >/dev/null 2>&1
                 fi
             fi
        done <<< "$files"
        
        # 3. Pull (Using standard interface, pulls everything in ~/.dfsync.json)
        if [[ "$CHECK_MODE" == "false" ]]; then
             "$bin" pull
        fi
    fi
}

show_help() {
    echo -e "${BLUE}Zen Load - Environment Restorer${NC}"
    echo -e "Usage: zen-load [OPTIONS]"
    echo -e "\n${YELLOW}Core:${NC}"
    echo -e "  (no args)   Stows packages and checks config health."
    echo -e "  --check     Dry-run Stow to detect conflicts."
    echo -e "\n${YELLOW}Installers:${NC}"
    echo -e "  --all       God Mode. Installs EVERYTHING (Brew, Stow, Fonts, dfsync, defaults)."
    echo -e "  --brew      Install Homebrew and packages."
    echo -e "  --dfsync    Install/Update dfsync and pull data."
    echo -e "  --npm       Install Node.js global packages."
    echo -e "  --vscode    Install VS Code extensions."
    echo -e "  --macos     Apply macOS system defaults."
    echo -e "\n${YELLOW}Flags:${NC}"
    echo -e "  -y          Auto-confirm dfsync prompts."
    echo -e "  -v          Verbose logging."
    echo -e "  --help      Show this help message."
    exit 0
}

# --- 1. Stow Logic ---
check_stow() {
    if ! command -v stow &> /dev/null; then
        echo -e "${YELLOW}Stow not found. Installing via Homebrew...${NC}"
        install_homebrew_core_only
        brew install stow
    fi
}

backup_file() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_dir="${ZEN_HOME}/graveyard/backups/${timestamp}"
    mkdir -p "$backup_dir"
    echo -e "  - Backing up $1 to $backup_dir/"
    mv "$1" "$backup_dir/"
}

resolve_conflicts() {
    echo -e "\n--- ‚öîÔ∏è  Resolving Conflicts ---"
    
    # 1. zshrc
    if [[ -f "${HOME}/.zshrc" && ! -L "${HOME}/.zshrc" ]]; then
        backup_file "${HOME}/.zshrc"
    fi
    # 1b. zimrc (Consolidate to zsh package)
    if [[ -f "${HOME}/.zimrc" && ! -L "${HOME}/.zimrc" ]]; then
        backup_file "${HOME}/.zimrc"
    fi
    
    # 2. gitconfig
    if [[ -f "${HOME}/.gitconfig" && ! -L "${HOME}/.gitconfig" ]]; then
        backup_file "${HOME}/.gitconfig"
    fi
    
    # 3. dfsync binary (Stow link vs Real file)
    if [[ -f "${HOME}/.local/bin/dfsync" && ! -L "${HOME}/.local/bin/dfsync" ]]; then
        echo -e "  - Replacing local dfsync binary with Stow link..."
        backup_file "${HOME}/.local/bin/dfsync"
    fi
}

run_stow() {
    local mode="$1"
    echo -e "\n--- üì¶ Stowing Packages ---"
    
    local stow_args=("-d" "$STOW_DIR" "-t" "$HOME" "--verbose=1")
    [[ "$mode" == "check" ]] && stow_args+=("-n")
    
    # Packages to stow (Updated: Removed rectangle, finder, launchd, zim)
run_stow_packages() {
    local pkgs=("$@")
    echo -e "\n--- üì¶ Stowing Packages: ${pkgs[*]} ---"
    
    local stow_args=("-d" "$STOW_DIR" "-t" "$HOME" "--verbose=1")
    if [[ "$CHECK_MODE" == "true" ]]; then
        stow_args+=("-n")
    else
        # Resolve conflicts for these specific packages?
        # For simplicity, we run the global resolve_conflicts once at start
        # or we just let Stow fail/warn if we didn't resolve.
        # Existing resolve_conflicts covers zshrc, gitconfig, dfsync only.
        :
    fi
    
    for pkg in "${pkgs[@]}"; do
        if [[ -d "${STOW_DIR}/${pkg}" ]]; then
            echo -e "  - Stowing ${pkg}..."
            stow -R "${stow_args[@]}" "$pkg" 2>&1 | sed 's/^/    /'
        else
            echo -e "${YELLOW}[WARN]${NC} Package $pkg not found in stow dir."
        fi
    done
}

# --- 2. Installers ---
install_homebrew_core_only() {
    if ! command -v brew &> /dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || /usr/local/bin/brew shellenv)"
    fi
}

install_homebrew() {
    echo -e "\n--- üç∫ Installing Homebrew Packages ---"
    # Prevent quarantine for casks (faster, cleaner)
    export HOMEBREW_CASK_OPTS="--no-quarantine"
    
    install_homebrew_core_only
    
    if [[ -f "$BREWFILE" ]]; then
        brew bundle install --file="$BREWFILE"
        echo -e "${GREEN}‚úîÔ∏é Brew bundle complete.${NC}"
        setup_fonts
    else
        echo -e "${YELLOW}[SKIP]${NC} No Brewfile found."
    fi
}

setup_fonts() {
    echo -e "\n--- üÖ∞Ô∏è  Setting up Fonts ---"
    local font_source="/opt/homebrew/share/fonts"
    local font_dest="${HOME}/Library/Fonts"
    local found_new=false

    if [[ -d "$font_source" ]]; then
        # Check specifically for JetBrains Nerd Font as WezTerm needs it
        for font in "$font_source"/*; do
            local fname=$(basename "$font")
            if [[ ! -f "${font_dest}/${fname}" ]]; then
                cp "$font" "$font_dest/"
                echo -e "  - Installed: $fname"
                found_new=true
            fi
        done
        
        if [[ "$found_new" == "true" ]]; then
            echo "Refreshing font cache..."
            atsutil server -shutdown 2>/dev/null || true
            atsutil server -ping 2>/dev/null || true
        else
            echo -e "${GREEN}‚úîÔ∏é Fonts already up to date.${NC}"
        fi
    else
        echo -e "${YELLOW}[WARN]${NC} No Homebrew fonts found at $font_source"
    fi
}


install_dfsync() {
    local force_update="$1"
    local dfsync_args="$2"
    echo -e "\n--- ‚òÅÔ∏è  Installing/Configuring dfsync ---"
    local bin_path="${HOME}/.local/bin/dfsync"
    local installed=false

    if [[ ! -x "$bin_path" || "$force_update" == "true" ]]; then
        # User requested ALWAYS fetch latest version (Self-Update)
        # We perform this check for every run to ensure strict version compliance.
        echo -e "Downloading latest dfsync..."
        if curl -fsSL "$DFSYNC_URL" -o "$bin_path" 2>/dev/null; then
            chmod +x "$bin_path"
            if head -n 1 "$bin_path" | grep -q "#!"; then
                echo -e "${GREEN}‚úîÔ∏é dfsync binary updated.${NC}"
                installed=true
            else
                echo -e "${RED}[ERROR]${NC} Invalid download."
                rm "$bin_path"
                return
            fi
        else
            echo -e "${RED}[ERROR]${NC} Download failed. Using existing binary if available."
            [[ -x "$bin_path" ]] && installed=true
        fi
    else
        # Fallback if somehow logic skips (shouldn't happen with user request)
        echo -e "${YELLOW}[SKIP]${NC} dfsync present."
        installed=true
    fi

    if [[ "$installed" == "true" ]]; then
        echo -e "Running dfsync setup..."
        "$bin_path" setup $dfsync_args
        echo -e "Running dfsync pull..."
        "$bin_path" pull $dfsync_args
    fi
}

install_npm_globals() {
    echo -e "\n--- üü¢ Installing NPM Globals ---"
    if command -v npm &> /dev/null && [[ -f "$NPM_LIST" ]]; then
        # Check if list is empty?
        grep -vE '^\s*#|^\s*$' "$NPM_LIST" | while read -r pkg; do
            npm list -g "$pkg" &> /dev/null || (echo "Installing $pkg..." && npm install -g "$pkg")
        done
    fi
}

install_vscode_extensions() {
    echo -e "\n--- üü£ Installing VS Code Extensions ---"
    if command -v code &> /dev/null && [[ -f "$VSCODE_LIST" ]]; then
        grep -vE '^\s*#|^\s*$' "$VSCODE_LIST" | \
        xargs -L 1 -P 4 code --install-extension --force > /dev/null 2>&1
        echo -e "${GREEN}‚úîÔ∏é Extensions installed.${NC}"
    fi
}

install_macos_defaults() {
    echo -e "\n--- üçé Applying macOS Defaults ---"
    # 3. Defaults
    if [[ -f "$MACOS_SCRIPT" ]]; then
        echo "Applying defaults..."
        chmod +x "$MACOS_SCRIPT"
        "$MACOS_SCRIPT"
    fi
    
    # 4. Install Config Backup Agent (Template -> Real)
    echo "Installing Config Backup Agent..."
    local template="${ZEN_HOME}/manifests/templates/com.template.configbackup.plist"
    local target="${HOME}/Library/LaunchAgents/com.shankar.configbackup.plist"
    
    if [[ -f "$template" ]]; then
        sed "s|{{HOME}}|${HOME}|g" "$template" > "$target"
        
        launchctl unload "$target" 2>/dev/null || true
        launchctl load "$target"
        echo "‚úîÔ∏é Config Backup Agent installed and loaded."
    fi
    
    # 5. Fix Finder Saved Search (Template -> Real)
    echo "Configuring Finder Recents..."
    local recents_template="${ZEN_HOME}/manifests/templates/Recents.savedSearch.template"
    local recents_target="${HOME}/Library/Saved Searches/Recents.savedSearch"
    if [[ -f "$recents_template" ]]; then
        mkdir -p "$(dirname "$recents_target")"
        sed "s|{{HOME}}|${HOME}|g" "$recents_template" > "$recents_target"
    fi

    echo -e "${GREEN}‚úîÔ∏é Defaults applied.${NC}"
}

# --- Main Logic ---
main() {
    export CHECK_MODE="false"
    export FORCE_ALL="false"
    local dfsync_flags=""

    for arg in "$@"; do
        case $arg in
            --check|-c)   CHECK_MODE="true" ;;
            --all)        FORCE_ALL="true" ;;
            --force)      FORCE_ALL="true" ;;
            -v)           dfsync_flags+=" -v" ;;
            --help|-h)    show_help ;;
        esac
    done

    echo "--- üöÄ Zen Load (Interactive) ---"
    if [[ "$CHECK_MODE" == "false" ]]; then
        echo -e "${YELLOW}üîê Admin privileges required for some tasks.${NC}"
        sudo -v
        while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
    else
        echo -e "${BLUE}üîç Check Mode Enabled (Dry Run)${NC}"
    fi

    # 1. Boilerplate (Dependencies)
    if [[ "$CHECK_MODE" == "false" ]]; then
        install_homebrew_core_only
        check_stow
        # Ensure dfsync is available
        install_dfsync "false" "$dfsync_flags"
        resolve_conflicts
    fi

    # 2. Shell Configuration (zsh, starship, git, bin)
    if prompt_user "üì¶ Stow Shell Environment (zsh, starship, git, bin)?"; then
        dfsync_activate "zshrc|zprofile|zimrc|starship|gitconfig"
        run_stow_packages "zsh" "starship" "git" "bin"
    fi

    # 3. Terminal (WezTerm)
    if prompt_user "üíª Stow WezTerm Configuration?"; then
        dfsync_activate "wezterm"
        run_stow_packages "wezterm"
        if [[ "$CHECK_MODE" == "false" ]]; then setup_fonts; fi
    fi

    # 4. Editor (VS Code)
    if prompt_user "üìù Install VS Code Config & Extensions?"; then
        dfsync_activate "vscode"
        run_stow_packages "vscode"
        if [[ "$CHECK_MODE" == "false" ]]; then install_vscode_extensions; fi
    fi

    # 5. System (macOS Defaults, Launchd, NPM?)
    if prompt_user "üçé Apply macOS Defaults & System Tweaks?"; then
        dfsync_activate "Raycast|Rectangle|Recents|LaunchAgents|defaults|Brewfile|npm_globals|installed_apps"
        if [[ "$CHECK_MODE" == "false" ]]; then 
            install_macos_defaults
            install_npm_globals
        fi
    fi

    echo -e "\n${GREEN}‚úîÔ∏é Zen Load Complete.${NC}"
}

main "$@"
